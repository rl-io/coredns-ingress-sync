# coredns-ingress-sync

[![codecov](https://codecov.io/github/rl-io/coredns-ingress-sync/graph/badge.svg?token=3IW3N6MURN)](https://codecov.io/github/rl-io/coredns-ingress-sync)

A Kubernetes controller that dynamically updates CoreDNS configuration based on Ingress resources, enabling automatic internal DNS resolution for ingress hostnames to the ingress-nginx service.

This eliminates the need to create internal ingress resources, manage private DNS zones, or manually update CoreDNS configurations - everything is handled automatically through a simple Helm chart deployment.

This has been tested to work with [ingress-nginx](https://github.com/kubernetes/ingress-nginx) but should in theory work with any ingress controller that supports the `ingressClassName` field and has a stable service name.

**Important Note:** This requires the ingress controller to handle TLS termination (have valid TLS certificates) for the hostnames you want to resolve internally. If the ingress controller lacks proper TLS certificates, internal services attempting to connect to the rewritten hostnames will fail with TLS errors. This occurs because clients will attempt HTTPS connections to the hostname, and the DNS rewrite only changes where the hostname resolvesâ€”not the protocol used to connect.

## Features

- **ðŸš€ Zero Configuration**: Works out-of-the-box with automatic CoreDNS setup
- **ðŸ”„ Event-driven**: Real-time response to ingress changes using controller-runtime
- **ðŸŽ¯ Selective Processing**: Only handles ingresses with specified IngressClass
- **âš¡ Dynamic DNS**: Auto-generates CoreDNS rewrite rules for ingress hostnames
- **ï¿½ï¸ Defensive Configuration**: Protects against external configuration drift (Terraform-compatible)
- **â™»ï¸ Clean Uninstall**: Automatic cleanup with proper Helm hooks
- **ðŸ” Secure**: Minimal RBAC permissions with namespace isolation
- **ï¿½ Leader election, health checks, comprehensive testing

## Quick Start

### Prerequisites

- Kubernetes cluster (1.25+) with CoreDNS
- Helm 3.x
- Ingress controller (nginx recommended)

> **Note**: Built and tested with Kubernetes client libraries v0.33.3. Compatible with Kubernetes 1.25+ due to client-go's backward compatibility.

### Installation

```bash
# Install from local chart
helm install coredns-ingress-sync ./helm/coredns-ingress-sync \
  --namespace coredns-ingress-sync \
  --create-namespace

# Or install from GitHub Packages
helm install coredns-ingress-sync \
  oci://ghcr.io/rl-io/charts/coredns-ingress-sync \
  --version 0.1.0 \
  --namespace coredns-ingress-sync \
  --create-namespace
```

### Verification

```bash
# Check controller status
kubectl get pods -n coredns-ingress-sync

# View logs
kubectl logs -n coredns-ingress-sync deployment/coredns-ingress-sync

# Test DNS resolution
kubectl run test-pod --rm -i --tty --image=busybox -- nslookup your-hostname.example.com
```

### Uninstall

```bash
helm uninstall coredns-ingress-sync -n coredns-ingress-sync
```

```dns
# Auto-generated by coredns-ingress-sync controller
# Last updated: 2025-01-16T10:30:00Z

rewrite name exact api.example.com ingress-nginx-controller.ingress-nginx.svc.cluster.local
rewrite name exact web.example.com ingress-nginx-controller.ingress-nginx.svc.cluster.local
```

### 4. **Cleanup on Uninstall**
The Helm chart includes pre-delete hooks that:

- **Remove Import Statement**: Removes the import line from CoreDNS Corefile
- **Remove Volume Mount**: Removes the custom volume mount
- **Remove Volume**: Removes the custom volume
- **Delete ConfigMap**: Removes the dynamic ConfigMap
- **Restore CoreDNS**: Restarts CoreDNS to apply the clean configuration

## Development

### Building from Source

```bash
# Clone the repository
git clone https://github.com/rl-io/coredns-ingress-sync.git
cd coredns-ingress-sync

# Build the binary
make build

# Build the Docker image
make docker-build

# Run tests
make test
```

### Local Development with Helm

```bash
# Install for local development
helm install coredns-ingress-sync ./helm/coredns-ingress-sync \
  --namespace coredns-ingress-sync \
  --create-namespace \
  --set image.tag=latest \
  --set image.pullPolicy=Never

# Watch logs
kubectl logs -n coredns-ingress-sync deployment/coredns-ingress-sync -f

# Test with sample ingress
kubectl apply -f - <<EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: test-ingress
  namespace: default
spec:
  ingressClassName: nginx
  rules:
  - host: test.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: test-service
            port:
              number: 80
EOF
```

### Testing

```bash
# Run all tests
./tests/run_tests.sh

# Run specific test suites
./tests/run_tests.sh --integration
./tests/run_tests.sh --e2e

# Test Helm chart specifically
./tests/test-helm-chart.sh
```

```go
// Controller extracts hostnames from ingress rules
hosts := []string{
## How It Works

The controller automatically discovers ingress hostnames and configures CoreDNS to resolve them internally:

1. **Ingress Discovery**: Watches for ingresses with the specified IngressClass (default: `nginx`)
2. **Hostname Extraction**: Collects all hostnames from matching ingress rules  
3. **DNS Configuration**: Generates CoreDNS rewrite rules mapping hostnames to the target service
4. **Automatic Updates**: Updates CoreDNS configuration in real-time as ingresses change
5. **Defensive Protection**: Restores configuration if modified by external tools (Terraform-compatible)

### Example

For ingresses with hostnames `api.example.com` and `web.example.com`, the controller generates:

```
rewrite name exact api.example.com ingress-nginx-controller.ingress-nginx.svc.cluster.local.
rewrite name exact web.example.com ingress-nginx-controller.ingress-nginx.svc.cluster.local.
```

## Configuration

Basic configuration through Helm values:

```yaml
controller:
  ingressClass: nginx
  targetCNAME: ingress-nginx-controller.ingress-nginx.svc.cluster.local.

coreDNS:
  autoConfigure: true
  namespace: kube-system
```

For detailed configuration options and examples, see [ðŸ“‹ Configuration Guide](docs/CONFIGURATION.md).

## Documentation

- **ðŸ“‹ [Configuration Guide](docs/CONFIGURATION.md)** - Detailed configuration options and examples
- **ðŸ—ï¸ [Architecture Guide](docs/ARCHITECTURE.md)** - Technical implementation and design details  
- **ðŸ”§ [Development Guide](docs/DEVELOPMENT.md)** - Setup, testing, and contribution instructions
- **ðŸš¨ [Troubleshooting Guide](docs/TROUBLESHOOTING.md)** - Common issues and solutions
- **â“ [FAQ](docs/FAQ.md)** - Frequently asked questions and answers

## Contributing

We welcome contributions! Please see the [Development Guide](docs/DEVELOPMENT.md) for:

- Setting up the development environment
- Running tests and validation
- Submitting pull requests
- Code standards and guidelines

## Support

- **ðŸ› Issues**: [GitHub Issues](https://github.com/your-org/coredns-ingress-sync/issues)
- **ðŸ’¬ Discussions**: [GitHub Discussions](https://github.com/your-org/coredns-ingress-sync/discussions)
- **ðŸ“– Documentation**: See the `docs/` directory for comprehensive guides

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
